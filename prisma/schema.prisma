// Prisma Schema for Logistics ERP System
// Based on DATABASE_SCHEMA.md specification

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum OrderStatus {
  UNASSIGNED      @map("미배정")
  ASSIGNED        @map("배정")
  CONFIRMED       @map("배정확정")
  RELEASED        @map("출고확정")
  DISPATCHED      @map("출문")
  POSTPONED       @map("연기")
  ABSENT          @map("부재")
  COMPLETED       @map("인수")
  PARTIAL         @map("부분인수")
  COLLECTED       @map("회수")
  CANCELLED       @map("취소")
  REQUEST_CANCEL  @map("의뢰취소")
}

enum Role {
  HQ_ADMIN
  BRANCH_MANAGER
  PARTNER_COORDINATOR
  INSTALLER
}

enum SettlementStatus {
  OPEN
  LOCKED
}

enum ReasonType {
  CANCEL
  POSTPONE
  ABSENCE
}

enum SyncStatus {
  PENDING
  SYNCED
  CONFLICT
  FAILED
}

enum OperationType {
  CREATE
  UPDATE
  DELETE
}

enum NotificationStatus {
  UNREAD
  READ
}

enum ExportStatus {
  PENDING
  PROCESSING
  READY
  FAILED
  EXPIRED
}

enum PushProvider {
  VAPID
  FCM
  APNS
}

enum Platform {
  WEB
  ANDROID
  IOS
}

// ============================================
// CORE TABLES
// ============================================

model User {
  id           String   @id @default(uuid())
  username     String   @unique @db.VarChar(64)
  passwordHash String   @map("password_hash")
  fullName     String   @map("full_name") @db.VarChar(120)
  email        String?  @db.VarChar(120)
  locale       String   @default("ko") @db.VarChar(5)
  branchId     String?  @map("branch_id")
  partnerId    String?  @map("partner_id")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  branch  Branch?  @relation(fields: [branchId], references: [id])
  partner Partner? @relation(fields: [partnerId], references: [id])
  roles   UserRole[]

  // Reverse relations
  orderStatusChanges  OrderStatusHistory[]
  appointmentChanges  Appointment[]
  splitOrders         SplitOrder[]
  serialNumbers       SerialNumber[]
  notifications       Notification[]
  exports             Export[]
  auditLogs           AuditLog[]
  offlineSyncQueue    OfflineSyncQueue[]
  attachments         Attachment[]
  settlementLocks     SettlementPeriod[]   @relation("LockedBy")
  settlementUnlocks   SettlementPeriod[]   @relation("UnlockedBy")
  notificationSubs    NotificationSubscription[]
  orderEventsCreated  OrderEvent[]         @relation("OrderEventCreatedBy")
  cancellationRecords CancellationRecord[] @relation("CancellationRecordCancelledBy")
  returnRecords       CancellationRecord[] @relation("CancellationRecordReturnedBy")

  @@map("users")
}

model UserRole {
  id     String @id @default(uuid())
  userId String @map("user_id")
  role   Role

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
  @@map("user_roles")
}

model Branch {
  id       String @id @default(uuid())
  code     String @unique @db.VarChar(10)
  name     String @db.VarChar(120)
  region   String @db.VarChar(50)
  timezone String @default("Asia/Seoul") @db.VarChar(40)

  // Relations
  users             User[]
  installers        Installer[]
  orders            Order[]
  settlementPeriods SettlementPeriod[]

  @@map("branches")
}

model Partner {
  id          String  @id @default(uuid())
  code        String  @unique @db.VarChar(20)
  name        String  @db.VarChar(120)
  contactName String? @map("contact_name") @db.VarChar(80)
  phone       String? @db.VarChar(30)
  email       String? @db.VarChar(120)
  isActive    Boolean @default(true) @map("is_active")

  // Relations
  users      User[]
  installers Installer[]
  orders     Order[]

  @@map("partners")
}

model Installer {
  id            String   @id @default(uuid())
  partnerId     String   @map("partner_id")
  branchId      String   @map("branch_id")
  name          String   @db.VarChar(120)
  phone         String   @db.VarChar(30)
  skillTags     String[] @map("skill_tags")
  capacityPerDay Int     @default(10) @map("capacity_per_day")
  isActive      Boolean  @default(true) @map("is_active")

  // Relations
  partner      Partner       @relation(fields: [partnerId], references: [id])
  branch       Branch        @relation(fields: [branchId], references: [id])
  orders       Order[]
  wastePickups WastePickup[]

  @@index([branchId, isActive])
  @@map("installers")
}

// ============================================
// ORDER TABLES
// ============================================

model Order {
  id                    String      @id @default(uuid())
  orderNo               String      @unique @map("order_no") @db.VarChar(30)
  customerName          String      @map("customer_name") @db.VarChar(120)
  customerPhone         String      @map("customer_phone") @db.VarChar(30)
  address               Json        // {line1, line2, city, postal}
  vendor                String      @db.VarChar(80)
  branchId              String      @map("branch_id")
  partnerId             String?     @map("partner_id")
  installerId           String?     @map("installer_id")
  status                OrderStatus @default(UNASSIGNED)
  appointmentDate       DateTime    @map("appointment_date") @db.Date
  appointmentTimeWindow String?     @map("appointment_time_window") // e.g., "09:00-12:00"
  promisedDate          DateTime    @map("promised_date") @db.Date
  remarks               String?
  version               Int         @default(1)
  deletedAt             DateTime?   @map("deleted_at")
  createdAt             DateTime    @default(now()) @map("created_at")
  updatedAt             DateTime    @updatedAt @map("updated_at")

  // Relations
  branch    Branch     @relation(fields: [branchId], references: [id])
  partner   Partner?   @relation(fields: [partnerId], references: [id])
  installer Installer? @relation(fields: [installerId], references: [id])

  // Reverse relations
  lines          OrderLine[]
  statusHistory  OrderStatusHistory[]
  appointments   Appointment[]
  parentSplits   SplitOrder[]         @relation("ParentOrder")
  childSplits    SplitOrder[]         @relation("ChildOrder")
  wastePickups   WastePickup[]
  notifications  Notification[]
  attachments    Attachment[]
  events         OrderEvent[]
  cancellationRecord CancellationRecord?

  @@index([branchId, status, appointmentDate])
  @@index([customerPhone])
  @@index([vendor, appointmentDate])
  @@map("orders")
}

model OrderEvent {
  id        String   @id @default(uuid())
  orderId   String   @map("order_id")
  eventType String   @map("event_type") @db.VarChar(30) // REMARK, NOTE, ISSUE, etc.
  note      String   // Special notes/remarks (특이사항)
  createdBy String   @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user  User  @relation("OrderEventCreatedBy", fields: [createdBy], references: [id])

  @@index([orderId, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@map("order_events")
}

model CancellationRecord {
  id              String   @id @default(uuid())
  orderId         String   @unique @map("order_id")
  reason          String   @map("reason") @db.VarChar(50) // CUSTOMER_REQUEST, OUT_OF_STOCK, etc.
  note            String?  @map("note")
  cancelledBy     String   @map("cancelled_by")
  cancelledAt     DateTime @default(now()) @map("cancelled_at")
  previousStatus  String   @map("previous_status") @db.VarChar(30) // Status before cancellation
  refundAmount    Decimal? @map("refund_amount") @db.Decimal(15, 2)
  refundProcessed Boolean  @default(false) @map("refund_processed")

  // Return tracking (환입 추적) - Manual Slide 19
  isReturned      Boolean  @default(false) @map("is_returned")
  returnedAt      DateTime? @map("returned_at")
  returnedBy      String?  @map("returned_by")

  // Relations
  order       Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user        User  @relation("CancellationRecordCancelledBy", fields: [cancelledBy], references: [id])
  returnUser  User? @relation("CancellationRecordReturnedBy", fields: [returnedBy], references: [id])

  @@index([orderId])
  @@index([cancelledAt(sort: Desc)])
  @@index([isReturned, cancelledAt(sort: Desc)])
  @@map("cancellation_records")
}

model OrderLine {
  id       String @id @default(uuid())
  orderId  String @map("order_id")
  itemCode String @map("item_code") @db.VarChar(30)
  itemName String @map("item_name") @db.VarChar(150)
  quantity Int
  weight   Decimal? @db.Decimal(8, 2)

  // Relations
  order         Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  serialNumbers SerialNumber[]
  splitOrders   SplitOrder[]

  @@map("order_lines")
}

model OrderStatusHistory {
  id             String      @id @default(uuid())
  orderId        String      @map("order_id")
  previousStatus OrderStatus @map("previous_status")
  newStatus      OrderStatus @map("new_status")
  changedBy      String      @map("changed_by")
  changedAt      DateTime    @default(now()) @map("changed_at")
  reasonCode     String?     @map("reason_code") @db.VarChar(30)
  notes          String?

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [changedBy], references: [id])

  @@index([orderId, changedAt(sort: Desc)])
  @@map("order_status_history")
}

model Appointment {
  id        String   @id @default(uuid())
  orderId   String   @map("order_id")
  oldDate   DateTime @map("old_date") @db.Date
  newDate   DateTime @map("new_date") @db.Date
  changedBy String   @map("changed_by")
  reason    String?
  changedAt DateTime @default(now()) @map("changed_at")

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [changedBy], references: [id])

  @@map("appointments")
}

model SplitOrder {
  id            String   @id @default(uuid())
  parentOrderId String   @map("parent_order_id")
  childOrderId  String   @map("child_order_id")
  lineId        String   @map("line_id")
  quantity      Int
  createdBy     String   @map("created_by")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  parentOrder Order     @relation("ParentOrder", fields: [parentOrderId], references: [id])
  childOrder  Order     @relation("ChildOrder", fields: [childOrderId], references: [id])
  line        OrderLine @relation(fields: [lineId], references: [id])
  user        User      @relation(fields: [createdBy], references: [id])

  @@map("split_orders")
}

// ============================================
// COMPLETION & WASTE TABLES
// ============================================

model WastePickup {
  id          String    @id @default(uuid())
  orderId     String    @map("order_id")
  code        String    @db.VarChar(4) // P01-P21
  quantity    Int
  collectedBy String?   @map("collected_by")
  collectedAt DateTime? @map("collected_at")

  // Relations
  order     Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  installer Installer? @relation(fields: [collectedBy], references: [id])

  @@unique([orderId, code])
  @@index([collectedAt, code])
  @@map("waste_pickups")
}

model SerialNumber {
  id          String   @id @default(uuid())
  orderLineId String   @map("order_line_id")
  serial      String   @unique @db.VarChar(40)
  recordedBy  String   @map("recorded_by")
  recordedAt  DateTime @default(now()) @map("recorded_at")

  // Relations
  orderLine OrderLine @relation(fields: [orderLineId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [recordedBy], references: [id])

  @@map("serial_numbers")
}

// ============================================
// NOTIFICATION TABLES
// ============================================

model Notification {
  id        String             @id @default(uuid())
  userId    String             @map("user_id")
  orderId   String?            @map("order_id")
  category  String             @db.VarChar(30) // REASSIGN, DELAY, CUSTOMER_REQUEST, etc.
  payload   Json
  status    NotificationStatus @default(UNREAD)
  createdAt DateTime           @default(now()) @map("created_at")
  readAt    DateTime?          @map("read_at")

  // Relations
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  order Order? @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([userId, status, createdAt(sort: Desc)])
  @@map("notifications")
}

model NotificationSubscription {
  id                 String       @id @default(uuid())
  userId             String       @map("user_id")
  deviceId           String       @map("device_id") @db.VarChar(64)
  platform           Platform
  pushProvider       PushProvider @map("push_provider")
  token              Json         // endpoint, keys for VAPID; token string for FCM/APNs
  categoriesEnabled  String[]     @map("categories_enabled")
  isActive           Boolean      @default(true) @map("is_active")
  createdAt          DateTime     @default(now()) @map("created_at")
  updatedAt          DateTime     @updatedAt @map("updated_at")
  expiresAt          DateTime?    @map("expires_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, deviceId])
  @@index([userId, isActive])
  @@map("notification_subscriptions")
}

// ============================================
// EXPORT & AUDIT TABLES
// ============================================

model Export {
  id        String       @id @default(uuid())
  type      String       @db.VarChar(30) // ecoas, completion, pending, waste, etc.
  filters   Json
  createdBy String       @map("created_by")
  status    ExportStatus @default(PENDING)
  fileUrl   String?      @map("file_url")
  expiresAt DateTime?    @map("expires_at")
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [createdBy], references: [id])

  @@map("exports")
}

model AuditLog {
  id        String   @id @default(uuid())
  tableName String   @map("table_name") @db.VarChar(50)
  recordId  String   @map("record_id")
  action    String   @db.VarChar(20) // CREATE, UPDATE, DELETE
  diff      Json     // {field: {old, new}}
  actor     String
  timestamp DateTime @default(now())

  // Relations
  user User @relation(fields: [actor], references: [id])

  @@index([tableName, recordId])
  @@index([timestamp(sort: Desc)])
  @@map("audit_logs")
}

// ============================================
// SETTLEMENT & LOOKUP TABLES
// ============================================

model SettlementPeriod {
  id          String           @id @default(uuid())
  branchId    String           @map("branch_id")
  periodStart DateTime         @map("period_start") @db.Date
  periodEnd   DateTime         @map("period_end") @db.Date
  status      SettlementStatus @default(OPEN)
  lockedBy    String?          @map("locked_by")
  lockedAt    DateTime?        @map("locked_at")
  unlockedBy  String?          @map("unlocked_by")
  unlockedAt  DateTime?        @map("unlocked_at")

  // Relations
  branch       Branch @relation(fields: [branchId], references: [id])
  lockedUser   User?  @relation("LockedBy", fields: [lockedBy], references: [id])
  unlockedUser User?  @relation("UnlockedBy", fields: [unlockedBy], references: [id])

  @@index([branchId, periodStart, periodEnd])
  @@map("settlement_periods")
}

model ReasonCode {
  id            String     @id @default(uuid())
  type          ReasonType
  code          String     @unique @db.VarChar(10)
  descriptionKo String     @map("description_ko") @db.VarChar(100)
  descriptionEn String     @map("description_en") @db.VarChar(100)
  isActive      Boolean    @default(true) @map("is_active")

  @@map("reason_codes")
}

// ============================================
// OFFLINE SYNC & ATTACHMENTS
// ============================================

model OfflineSyncQueue {
  id              String        @id @default(uuid())
  userId          String        @map("user_id")
  operationType   OperationType @map("operation_type")
  entityType      String        @map("entity_type") @db.VarChar(30)
  entityId        String        @map("entity_id")
  payload         Json
  expectedVersion Int?          @map("expected_version")
  status          SyncStatus    @default(PENDING)
  retryCount      Int           @default(0) @map("retry_count")
  lastError       String?       @map("last_error")
  createdAt       DateTime      @default(now()) @map("created_at")
  syncedAt        DateTime?     @map("synced_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([status, createdAt])
  @@map("offline_sync_queue")
}

model Attachment {
  id         String   @id @default(uuid())
  orderId    String   @map("order_id")
  fileName   String   @map("file_name") @db.VarChar(255)
  fileType   String   @map("file_type") @db.VarChar(50)
  fileSize   Int      @map("file_size")
  storageKey String   @map("storage_key") @db.VarChar(255)
  uploadedBy String   @map("uploaded_by")
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [uploadedBy], references: [id])

  @@map("attachments")
}

// ============================================
// WASTE CODE LOOKUP
// ============================================

model WasteCode {
  id            String  @id @default(uuid())
  code          String  @unique @db.VarChar(4) // P01-P21
  descriptionKo String  @map("description_ko") @db.VarChar(100)
  descriptionEn String  @map("description_en") @db.VarChar(100)
  isActive      Boolean @default(true) @map("is_active")

  @@map("waste_codes")
}
